name: Update Dependencies

on:
  schedule:
    # æ¯å‘¨ä¸€æ—©ä¸Š 8 ç‚¹è¿è¡Œ
    - cron: '0 8 * * MON'
  workflow_dispatch:

jobs:
  update-dependencies:
    name: Update Cargo Dependencies
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable

    - name: Install cargo-edit
      run: cargo install cargo-edit

    - name: Update dependencies
      run: |
        # æ›´æ–°æ‰€æœ‰ä¾èµ–åˆ°æœ€æ–°çš„å…¼å®¹ç‰ˆæœ¬
        cargo update

        # æ£€æŸ¥æ˜¯å¦æœ‰å¯ä»¥å‡çº§çš„ä¾èµ–
        cargo upgrade --dry-run > upgrade-report.txt || true

        # å¦‚æœæœ‰å¯å‡çº§çš„ä¾èµ–ï¼Œåˆ›å»º issue
        if [ -s upgrade-report.txt ]; then
          echo "å‘ç°å¯å‡çº§çš„ä¾èµ–é¡¹"
          cat upgrade-report.txt
        fi

    - name: Run tests
      run: |
        cargo fmt --all -- --check
        cargo clippy --workspace --all-targets -- -D warnings
        cargo test --workspace

    - name: Check for changes
      id: git-check
      run: |
        git diff --exit-code || echo "changes=true" >> $GITHUB_OUTPUT

    - name: Commit changes
      if: steps.git-check.outputs.changes == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add Cargo.lock
        git commit -m "chore(deps): update Cargo dependencies" || exit 0

    - name: Create Pull Request
      if: steps.git-check.outputs.changes == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "chore(deps): update Cargo dependencies"
        title: "ğŸ”„ è‡ªåŠ¨æ›´æ–° Cargo ä¾èµ–é¡¹"
        body: |
          ## ğŸ“¦ ä¾èµ–é¡¹è‡ªåŠ¨æ›´æ–°

          è¿™ä¸ª PR åŒ…å«äº†è‡ªåŠ¨æ›´æ–°çš„ Cargo ä¾èµ–é¡¹ã€‚

          ### ğŸ” æ›´æ–°å†…å®¹
          - æ›´æ–°äº† `Cargo.lock` æ–‡ä»¶ä¸­çš„ä¾èµ–ç‰ˆæœ¬
          - æ‰€æœ‰æµ‹è¯•éƒ½å·²é€šè¿‡
          - ä»£ç æ ¼å¼å’Œ Clippy æ£€æŸ¥éƒ½å·²é€šè¿‡

          ### âœ… éªŒè¯
          - [x] ä»£ç æ ¼å¼åŒ–æ£€æŸ¥é€šè¿‡
          - [x] Clippy æ£€æŸ¥é€šè¿‡
          - [x] æ‰€æœ‰æµ‹è¯•é€šè¿‡

          è¿™ä¸ª PR æ˜¯ç”± GitHub Actions è‡ªåŠ¨åˆ›å»ºçš„ã€‚è¯·ä»”ç»†å®¡æŸ¥æ›´æ”¹å¹¶åˆå¹¶ã€‚
        branch: update-dependencies
        delete-branch: true
